name: üî• Build Android APK for RuStore

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: üöÄ Checkout code
      uses: actions/checkout@v4
      
    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm install
      
    - name: üèóÔ∏è Check file structure
      run: |
        echo "üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤:"
        ls -la
        echo "‚úÖ –§–∞–π–ª—ã –≥–æ—Ç–æ–≤—ã"
      
    - name: ‚òï Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ü§ñ Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: üîß Setup Capacitor
      run: |
        # –°—Ç–∞–≤–∏–º Capacitor
        npm install @capacitor/core @capacitor/cli
        npm install @capacitor/android
        
        # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å –ö–û–†–ù–ï–í–û–ô –ø–∞–ø–∫–æ–π
        npx cap init "–ö–æ–¥ –ò—Ü–∑–∏–Ω" "com.iching.codeiching" --web-dir .
        
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
        npx cap sync android
        
        echo "‚úÖ Capacitor –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É"
      
    - name: üîê Setup signing key
      run: |
        # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–ª—é—á –¥–ª—è —Ç–µ—Å—Ç–∞ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∑–∞–º–µ–Ω–∏—à—å –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∏–π)
        if [ ! -f "code_iching.jks" ]; then
          echo "üîë –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á..."
          keytool -genkey -v -keystore code_iching.jks -alias code_iching -keyalg RSA -keysize 2048 -validity 10000 -storepass password123 -keypass password123 -dname "CN=I Ching, OU=Android, O=Code Iching, L=Moscow, ST=Moscow, C=RU"
        fi
        
    - name: üè≠ Build Android APK
      run: |
        cd android
        chmod +x gradlew
        
        # –°–æ–±–∏—Ä–∞–µ–º APK —Å –ø–æ–¥–ø–∏—Å—å—é
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=../code_iching.jks \
          -Pandroid.injected.signing.store.password=password123 \
          -Pandroid.injected.signing.key.alias=code_iching \
          -Pandroid.injected.signing.key.password=password123
          
        echo "‚úÖ APK —Å–æ–±—Ä–∞–Ω!"
        
    - name: üì± Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: code-iching-apk
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 30
        
    - name: üè∑Ô∏è Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: android/app/build/outputs/apk/release/app-release.apk
        body: |
          üéâ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ APK –¥–ª—è RuStore
          
          üì± **–ö–æ–¥ –ò—Ü–∑–∏–Ω** - –≥–∞–¥–∞–Ω–∏–µ –ø–æ –¥—Ä–µ–≤–Ω–µ–∫–∏—Ç–∞–π—Å–∫–æ–π –ö–Ω–∏–≥–µ –ü–µ—Ä–µ–º–µ–Ω
          
          üîê APK –ø–æ–¥–ø–∏—Å–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ RuStore
          
          üì¶ –°–æ–±—Ä–∞–Ω–æ: ${{ github.ref }}
